// Generated by CoffeeScript 1.9.0
(function() {
  var DEFAULT_EXTENSION, DEFAULT_PROTOCOL, FIRST_LINE_REGEX, METHOD_REGEX, PARENT_DIRECTORY_REGEX, ROOT, ServerOptions, contentTypeMap, createResponseHeader, errorHtml, ext, extractStatusLine, fs, net, newContentTypeMap, path, server, statusCode, subType, tab, type, _i, _len, _ref;

  fs = require('fs');

  net = require('net');

  path = require('path');

  ROOT = __dirname + '/webroot';

  DEFAULT_PROTOCOL = 'HTTP/1.0';

  DEFAULT_EXTENSION = '.html';

  FIRST_LINE_REGEX = new RegExp("(GET|POST|HEAD)[ ]([\/].*[ ]){1,}HTTP\/1\.[0-9]");

  PARENT_DIRECTORY_REGEX = new RegExp("[\.]{2,}[\/].*");

  METHOD_REGEX = new RegExp("(GET|POST|HEAD)");

  statusCode = {
    200: "OK",
    201: "Created",
    202: "Accepted",
    204: "No Content",
    301: "Moved Permanently",
    302: "Moved Temporarily",
    304: "Not Modified",
    400: "Bad Request",
    401: "Unauthorized",
    403: "Forbidden",
    404: "Not Found",
    500: "Internal Server Error",
    501: "Not Implemented",
    502: "Bad Gateway",
    503: "Service Unavailable"
  };

  contentTypeMap = {
    'image': {
      tab: [".jpg", ".jpeg", ".png", ".bmp", ".gif"]
    },
    'application': {
      tab: ['.js'],
      replace: ['javascript']
    },
    'video': {
      tab: ['.mp4']
    },
    'audio': {
      tab: ['.mp3']
    },
    'text': {
      tab: ['.html', '.css']
    }
  };

  newContentTypeMap = [];

  for (type in contentTypeMap) {
    tab = contentTypeMap[type];
    _ref = tab['tab'];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      ext = _ref[_i];
      subType = tab['replace'] === void 0 ? ext.replace('.', '') : tab['replace'];
      newContentTypeMap.push((newContentTypeMap[ext] = type + "/" + subType));
    }
  }

  errorHtml = function(code) {
    return {
      body: "<!DOCTYPE html> <html> <head> <title>Webserver Test</title> <meta charset='utf-8'> </head> <body> <H2>" + code + " " + statusCode[code] + "</H2> </body> </html>",
      toString: function() {
        return this.body.toString();
      }
    };
  };

  extractStatusLine = function(data) {
    var firstLine, requestLineArray, requestLineJSON;
    firstLine = (data.toString().split("\r\n"))[0];
    if (FIRST_LINE_REGEX.test(firstLine)) {
      requestLineArray = firstLine.split(" ");
      requestLineJSON = {
        "method": requestLineArray[0],
        "path": requestLineArray[1] === '/' ? 'index.html' : requestLineArray[1],
        "protocol": requestLineArray[2]
      };
      return requestLineJSON;
    }
    return null;
  };

  createResponseHeader = function(protocole, code, ext, lengthFile) {
    return {
      statusLine: protocole + " " + code + " " + statusCode[code] + "\r\n",
      date: '',
      server: '',
      contentType: "Content-Type: " + (ext && newContentTypeMap[ext] ? newContentTypeMap[ext] + "\r\n" : "text/plain\r\n"),
      contentLength: lengthFile ? "Content-Length: " + lengthFile + "\r\n" : "Content-Length: 0\r\n",
      expires: '',
      lastModified: '',
      connection: "Connection: close\r\n",
      toString: function() {
        return "" + this.statusLine + this.date + this.contentType + this.contentLength + this.connection + "\r\n";
      }
    };
  };

  ServerOptions = {
    allowHalfOpen: false,
    pauseOnConnect: false
  };

  server = net.createServer(ServerOptions, function(socket) {
    socket.on('connection', function() {
      return console.log('socket : connect');
    });
    return socket.on('data', function(data) {
      var absolutePath, extension, headerResponse, requestLineHeader;
      requestLineHeader = extractStatusLine(data);
      if (requestLineHeader) {
        absolutePath = path.join(ROOT, requestLineHeader['path']);
        extension = path.extname(absolutePath.toLowerCase());
        return fs.stat(absolutePath, function(err, stats) {
          var codeError, headerResponse, readStream;
          codeError = null;
          if (err) {
            codeError = 404;
          } else if (PARENT_DIRECTORY_REGEX.test(requestLineHeader['path'] || stats.isDirectory())) {
            codeError = 403;
          } else if (stats.isFile()) {
            headerResponse = createResponseHeader(DEFAULT_PROTOCOL, 200, extension, stats["size"]);
            readStream = fs.createReadStream(absolutePath);
          }
          if (codeError) {
            headerResponse = createResponseHeader(DEFAULT_PROTOCOL, codeError, DEFAULT_EXTENSION, Buffer.byteLength((errorHtml(codeError)).toString(), 'utf8'));
            socket.write(headerResponse.toString(), function() {
              return socket.write((errorHtml(codeError)).toString() + '\n');
            });
          }
          if (readStream) {
            readStream.on('open', function() {
              if ((requestLineHeader['method'].toUpperCase() === 'GET') || (requestLineHeader['method'].toUpperCase() === 'POST')) {
                return socket.write(headerResponse.toString(), function() {
                  return readStream.pipe(socket);
                });
              } else {
                return socket.write(headerResponse.toString());
              }
            });
            return readStream.on('end', function() {
              return socket.end();
            });
          }
        });
      } else {
        headerResponse = createResponseHeader(DEFAULT_PROTOCOL, 400);
        return socket.write(headerResponse.toString());
      }
    });
  });

  server.listen(9000, 'localhost');

}).call(this);
